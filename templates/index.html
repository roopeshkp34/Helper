<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Karo</title>
    <link rel="stylesheet" href="{% static 'css/style-dark.min.css' %}" />
    <script src="{% static 'js/jquery.min.js' %}"></script>
</head>
<body>
    <div class="body-wrapper">
    <div class="container-fluid">
        <div class="product-list">
          <div class="card">
            <div class="card-body p-3">
              <div class="d-flex justify-content-between align-items-center mb-9">
                <div class="d-flex align-items-center" >
                  <!-- <form class="position-relative" id="srch_frm"> -->
                    <input type="text" class="form-control search-chat py-2" id="text-srh" name="search" placeholder="Search Users">
                  <!-- </form> -->
                  <button type="button" id="search_btn" class="d-inline-flex align-items-center justify-content-center btn  btn-lg">
                    <i style="top: 20px;" class="ti ti-search fs-6 " title="Search"></i>
                  </button>
                  
                </div>
    
                <div class="btn-group">
                  <button class="btn btn-light-secondary text-secondary font-medium btn-sm" id="create" type="button" >
                    Create
                  </button>
                  
                </div>
              </div>
              <div class="bootstrap-table bootstrap5">
      
                <div class="fixed-table-container has-footer">
                  <div class="fixed-table-body">
                    <table class="table table-bordered table-hover" id="userTable">
                      <thead class="">
                        <tr>
                          <th style="text-align: center; " data-field="number">
                            <div class="th-inner">No.</div>
                            <div class="fht-cell"></div>
                          </th>
                          <th style="text-align: center; ">
                            <div class="th-inner">Name</div>
                            <div class="fht-cell"></div>
                          </th>
                          <th style="text-align: center; ">
                            <div class="th-inner ">Details</div>
                            <div class="fht-cell"></div>
                          </th>
                          <th style="text-align: center; ">
                            <div class="th-inner ">Amount</div>
                            <div class="fht-cell"></div>
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for object in objects %}
                        <tr data-index="0" data-has-detail-view="true">
                          <td style="text-align: center; ">{{object.refer_id}}</td>
                          <td style="text-align: center; ">{{object.first_name}}  -  {{object.last_name}}</td>
                          <td style="text-align: center; ">{{object.details}}</td>
                          <td style="text-align: center; ">{{object.amount}}</td>
                          <td style="text-align: center; "><a class="like" id="view_booking" data-id={{object.id}} title="View"><i
                                class="fas fa-eye" title="View"></i></a> 
                                <!-- <a class="remove" href="javascript:void(0)" title="Remove"><i
                                class="fas fa-trash"></i></a> -->
                          </td>
                        </tr>
                        {% endfor %}
                        {% if not objects %}
                        <tr><td colspan="6" align="center">No data</td></tr>
                        {% endif %}
                      </tbody>
                    </table>
                  </div>
                </div>
                <!-- <div class="fixed-table-pagination">
                  {% if objects %}
                  <div class="float-left pagination-detail"><span class="pagination-info">
                      Showing {{ objects.start_index }} to {{ objects.end_index }} of {{ total_items }}
                    </span>
                  </div>
                  {% if objects.has_other_pages %}
                  <div class="float-right pagination">
                    <ul class="pagination">
                      {% if objects.has_previous %}
                      <li class="page-item page-pre"><a class="page-link" aria-label="previous page"
                          href="?page={{ objects.previous_page_number }}">‹</a></li>
                      {% endif %}
                      {% if objects.number|add:'-4' > 1 %}
                      <li class="page-item active"><a class="page-link" aria-label="to page 1"
                          href="?page={{ objects.number|add:'-5' }}"></a></li>
                      {% endif %}
                      {% for i in objects.paginator.page_range %}
                      {% if objects.number == i %}
                      <li class="page-item active"><a class="page-link" aria-label="to page {{ i }}" href="javascript:void(0)">{{ i }}</a></li>
                      {% elif i > objects.number|add:'-5' and i < objects.number|add:'5' %}
                      <li class="page-item"><a class="page-link" aria-label="to page {{ i }}" href="?page={{ i }}">{{ i }}</a></li>
                      {% else %}
                      <li class="disabled"></li>
                      {% endif %}
                      {% endfor %}
                      {% if objects.paginator.num_pages > objects.number|add:'4' %}
                      <li class="page-item"><a class="page-link" aria-label="to page {{ objects.number|add:'5' }}" href="?page={{ objects.number|add:'5' }}">{{ i }}</a></li>
                      {% endif %}
                      
                      {% if objects.has_next %}
                      <li class="page-item page-next"><a class="page-link" aria-label="next page"
                          href="?page={{ objects.next_page_number }}">›</a></li>
                      {% endif %}
                    </ul>
                  </div>
                  {% endif %}
                  {% endif %}
                </div> -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- dark Header Modal -->
<div class="modal fade" id="create-modal" tabindex="-1" aria-labelledby="exampleModalLabel1">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header d-flex align-items-center">
          <h4 class="modal-title" id="exampleModalLabel1">
            Add New Kuri
          </h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form enctype="multipart/form-data" id="kuri_form">
            <input type="hidden" class="form-control" name="kuri_id" id="kuri_id">
            <div class="mb-3">
              <label for="no" class="control-label">No:</label>
              <input type="text" class="form-control" id="number" >
              <span class="no_error haserror"></span>
            </div>
            <div class="mb-3">
              <label for="first_name" class="control-label">First Name:</label>
              <input type="text" class="form-control" id="first_name">
              <span class="first_name_error haserror"></span>
            </div>
            <div class="mb-3">
                <label for="last_name" class="control-label">Last Name:</label>
                <input type="text" class="form-control" id="last_name">
                <span class="last_name_error haserror"></span>
              </div>
          </form>
          <div class="mb-3">
            <label for="details" class="control-label">Details:</label>
            <input type="text" class="form-control" id="details">
            <span class="details_error haserror"></span>
          </div>
          <div class="mb-3">
            <label for="amount" class="control-label">Amount:</label>
            <input type="text" class="form-control" id="amount">
            <span class="amount_error haserror"></span>
          </div>
          <div class="mb-3">
            <label for="image" class="control-label">File:</label>
            <input type="file"  class="form-control" id="file">
          </div>
      </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light-danger text-danger font-medium" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-success" id="saveBtn">Add</button>
        </div>
      </div>
    </div>
</div>
<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
  <!-- /.modal -->
    <script>
        $(document).ready(function(){
            console.log("loaded");
            $(document).on("click", "#create", function(){
                $('#create-modal').modal('show');
            });

            // save
            $(document).on("click", "#saveBtn", function(event){
              event.preventDefault();
              var formData = new FormData();
              formData.append('file', $('#file')[0].files[0]);
              formData.append("number", $("#number").val());
              formData.append("first_name", $("#first_name").val());
              formData.append("last_name", $("#last_name").val());
              formData.append("details", $("#details").val());
              formData.append("amount", $("#amount").val());

              const csrftoken = getCookie('csrftoken');
              console.log(formData);
              $.ajax({
                url: "/save",
                method: "POST",
                contentType: false,
                processData: false,
                data: formData,
                headers: {
                  'X-CSRFToken': csrftoken,
                },
                success: function(response){
                  if(response.status == "success"){
                    $('#create-modal').modal('hide');
                    location.reload();
                  }else{
                    $('#create-modal').modal('hide');
                    alert(response.message)
                  }
                }
              })
            });

            $(document).on("click", "#search_btn", function(){
              userSearch($("#text-srh").val());
            });

            $(document).on("change", "#text-srh", function(){
              userSearch($("#text-srh").val());
            });
        });
      
      function userSearch(searchTerm){
        $.ajax({
          url: "/search_user",
          method: "get",
          dataType: "json",
          data: {"search_term": searchTerm},
          success: function(response){
            if(response.status == "success"){
              var tbody = $('#userTable tbody');
                $("#userTable tbody tr").each(function () {
                  this.parentNode.removeChild(this);
                });

                $.each(response.data, function(index, item){
                  var row = '<tr><td style="text-align: center; ">' + item.refer_id + '</td><td style="text-align: center; ">' + item.first_name +' '+ item.last_name + '</td><td style="text-align: center; ">' + item.details + '</td><td style="text-align: center; ">' + item.amount + '</td><td style="text-align: center; "><a class="like" id="view_booking" data-id=' + item.id + ' title="View"><i class="fas fa-eye" title="View"></i></a></td></tr>';
                  tbody.append(row);
                });
            }else{
              console.log("Failed to get user");
            }
          }
        })
      };

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
  const csrftoken = getCookie('csrftoken');
    </script>
</body>
</html>